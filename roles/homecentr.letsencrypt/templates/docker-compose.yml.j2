version: '3.7'
services:
  letsencrypt:
    image: {{ letsencrypt_docker_image_tag }}
    environment:
      PUID: "{{ cnt_uid }}"
      PGID: "{{ cnt_gid }}"
      TZ: "{{ timezone }}"
      URL: "{{ dns_root_domain }}"
      SUBDOMAINS: "wildcard"
      VALIDATION: "dns"
      DNSPLUGIN: "cloudflare"
      EMAIL: "{{ letsencrypt_email }}"
      DHLEVEL: "{{ letsencrypt_dhlevel }}"
      STAGING: "{{ letsencrypt_staging }}"
    volumes:
      - "certs:/config"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.role == manager]

volumes:
  certs:
    driver: glusterfs
    name: "{{ gluster_config_volume_name }}/ssl"